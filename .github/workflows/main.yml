name: SHRP Recovery Build

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: "SHRP Manifest Branch"
        required: true
        default: shrp-12.1
      DEVICE_TREE_URL:
        description: "Device Tree URL"
        required: true
        default: https://github.com/H1p4zdev/device_xiaomi_stone_twrp.git
      DEVICE_TREE_BRANCH:
        description: "Device Tree Branch"
        required: true
        default: master
      DEVICE_PATH:
        description: "Path to place device tree"
        required: true
        default: device/xiaomi/stone
      DEVICE_NAME:
        description: "Device Codename"
        required: true
        default: stone
      BUILD_TARGET:
        description: "Build target (boot/recovery/vendor_boot)"
        required: true
        default: boot
      INCLUDE_INSTALLER:
        description: "Include recovery installer zip"
        required: true
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OUTPUT_DIR: out_artifacts
      PATH: ~/bin:$PATH

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses-dev x11proto-core-dev \
            libx11-dev lib32z1-dev ccache libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
            python3 openjdk-11-jdk bc rsync imagemagick schedtool lzop lz4 pngcrush

      - name: Add Swap (8GB)
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install repo Tool
        run: |
          mkdir -p ~/bin
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV

      - name: Initialize SHRP Source
        run: |
          mkdir -p workspace
          cd workspace
          repo init -u https://github.com/SHRP-Reborn/manifest.git -b ${{ github.event.inputs.MANIFEST_BRANCH }} --depth=1
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

      - name: Clone Device Tree
        run: |
          cd workspace
          mkdir -p $(dirname ${{ github.event.inputs.DEVICE_PATH }})
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ${{ github.event.inputs.DEVICE_PATH }}

      - name: Build Recovery
        run: |
          cd workspace
          export ALLOW_MISSING_DEPENDENCIES=true
          source build/envsetup.sh
          lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng
          if [ "${{ github.event.inputs.INCLUDE_INSTALLER }}" = "true" ]; then
            export USE_RECOVERY_INSTALLER=true
            export RECOVERY_INSTALLER_PATH=bootable/recovery/installer
          fi
          mka ${{ github.event.inputs.BUILD_TARGET }}image

      - name: Package Artifacts
        run: |
          mkdir -p $OUTPUT_DIR
          zip -r $OUTPUT_DIR/${{ github.event.inputs.DEVICE_NAME }}_${{ github.event.inputs.MANIFEST_BRANCH }}.zip \
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*

      - name: Cleanup (Save Space)
        run: |
          sudo swapoff /swapfile
          sudo rm /swapfile
          rm -rf workspace/.repo
          rm -rf workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/obj

      - name: Upload Build Output
        uses: actions/upload-artifact@v4
        with:
          name: shrp-${{ github.event.inputs.DEVICE_NAME }}-${{ github.event.inputs.MANIFEST_BRANCH }}
          path: ${{ env.OUTPUT_DIR }}
